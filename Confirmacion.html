<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Confirmar Asistencia</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet" />

  <style>
    :root{
      /* üé® Marr√≥n del arte (pod√©s ajustar fino si quer√©s) */
      --brand-brown: #4B3523;
      --brand-brown-600: #3F2B1B;  /* hover/active */
      --brand-contrast: #ffffff;

      /* Capa transl√∫cida para legibilidad del contenido sobre fondo oscuro */
      --scrim: rgba(255,255,255,.86);

      /* Tarjetas del formulario */
      --card-bg: rgba(255,255,255,.96);
      --card-border: #e5e7eb;
    }

    /* Fondo marr√≥n liso en toda la p√°gina */
    html, body{
      height: 100%;
      margin: 0;
      background-color: var(--brand-brown);
      color: #111;
    }

    /* Capa de suavizado para que el formulario se lea bien */
    .page-scrim{
      min-height: 100vh;
      background: var(--scrim);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    /* T√≠tulo */
    .titulo{
      font-weight: 800;
      letter-spacing: .02em;
      color: #1a1a1a;
      text-align: center;
    }

    /* Tarjetas por invitado */
    .registro{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: .6rem;
      padding: 1rem;
    }
    .registro + .registro{ margin-top: 1rem; }

    /* Botones con tema marr√≥n */
    .btn-brand{
      background-color: var(--brand-brown);
      border-color: var(--brand-brown);
      color: var(--brand-contrast);
    }
    .btn-brand:hover,
    .btn-brand:focus{
      background-color: var(--brand-brown-600);
      border-color: var(--brand-brown-600);
      color: var(--brand-contrast);
    }

    .btn-outline-brand{
      color: var(--brand-brown);
      border-color: var(--brand-brown);
      background: transparent;
    }
    .btn-outline-brand:hover,
    .btn-outline-brand:focus{
      color: var(--brand-contrast);
      background-color: var(--brand-brown);
      border-color: var(--brand-brown);
    }

    /* Lista de confirmados en negrita */
    #listaNombres li { font-weight: 700; }

    /* Utilidad */
    .oculto{ display: none !important; }
  </style>
</head>

<body>
  <!-- Capa de lectura sobre el fondo marr√≥n -->
  <div class="page-scrim">
    <div class="container py-4">

      <!-- T√≠tulo -->
      <h3 id="titulo-principal" class="titulo mb-4">
        Por favor confirm√° tu asistencia a mi Cumple
      </h3>

      <!-- ‚úÖ Formulario visible desde el inicio (sin bot√≥n previo) -->
      <div id="form-container">
        <form id="asistenciaForm" novalidate>
          <div id="registros-container">

            <!-- REGISTRO 1 -->
            <div class="registro" data-index="1">
              <h5>Invitado 1</h5>

              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Nombre *</label>
                  <input type="text" id="nombre-1" class="form-control" required>
                </div>

                <div class="col-12">
                  <label class="form-label">Apellido *</label>
                  <input type="text" id="apellido-1" class="form-control" required>
                </div>

                <div class="col-12">
                  <label class="form-label">DNI *</label>
                  <input type="text" id="dni-1" class="form-control" maxlength="9" inputmode="numeric" required>
                  <div class="form-text">Solo n√∫meros (7 a 9 d√≠gitos).</div>
                </div>

                <!-- EMAIL oculto (se mantiene para el env√≠o) -->
                <input type="hidden" id="email-1" value="" class="d-none">

                <div class="col-12">
                  <label class="form-label">Comentarios (opcional)</label>
                  <textarea id="comentarios-1" class="form-control"></textarea>
                </div>

                <input type="hidden" id="fecha-1">
              </div>
            </div>

            <!-- REGISTROS 2..5 GENERADOS -->
            <script>
              for (let i = 2; i <= 5; i++) {
                document.write(`
                  <div class="registro oculto" data-index="${i}">
                    <h5>Invitado ${i}</h5>
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label">Nombre *</label>
                        <input type="text" id="nombre-${i}" class="form-control">
                      </div>
                      <div class="col-12">
                        <label class="form-label">Apellido *</label>
                        <input type="text" id="apellido-${i}" class="form-control">
                      </div>
                      <div class="col-12">
                        <label class="form-label">DNI *</label>
                        <input type="text" id="dni-${i}" class="form-control" maxlength="9" inputmode="numeric">
                      </div>
                      <input type="hidden" id="email-${i}" class="d-none">
                      <div class="col-12">
                        <label class="form-label">Comentarios</label>
                        <textarea id="comentarios-${i}" class="form-control"></textarea>
                      </div>
                      <input type="hidden" id="fecha-${i}">
                    </div>
                  </div>
                `);
              }
            </script>

          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" id="btnAgregar" class="btn btn-outline-brand flex-fill">
              Agregar otro Invitado
            </button>

            <button type="submit" class="btn btn-brand flex-fill">
              ENVIAR
            </button>
          </div>

        </form>
      </div>

      <!-- RESULTADO -->
      <div id="resultado" class="d-none mt-4">
        <div class="card">
          <div class="card-body">
            <h4 class="text-success mb-3">Muchas gracias por confirmar tu presencia</h4>
            <p></p>
            <ul id="listaNombres"></ul>

            <!-- ‚¨áÔ∏è Bot√≥n marr√≥n para volver a la invitaci√≥n -->
            <div class="text-center mt-3">
              <a href="./index.html" class="btn btn-brand btn-lg px-4">VOLVER A LA INVITACI√ìN</a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const WEBAPP_URL =
      "https://script.google.com/macros/s/AKfycbzN7znUk70M2EYjRk_5u4FgHO374tc2eTcffjXaGQqhacZH6B92ujkVkivpitY6Jbd-/exec";

    const formContainer   = document.getElementById("form-container");
    const btnAgregar      = document.getElementById("btnAgregar");
    const resultado       = document.getElementById("resultado");
    const listaNombresEl  = document.getElementById("listaNombres");
    const tituloPrincipal = document.getElementById("titulo-principal");

    /* ‚úÖ Mostrar formulario de entrada y setear fecha al cargar */
    document.addEventListener('DOMContentLoaded', () => {
      setFechaHoy();
    });

    // Agregar persona (m√°ximo 5)
    btnAgregar.addEventListener("click", () => {
      const ocultos = [...document.querySelectorAll(".registro.oculto")];
      if (ocultos.length > 0) ocultos[0].classList.remove("oculto");
    });

    // Setear fecha oculta a hoy (AAAA-MM-DD)
    function setFechaHoy() {
      const hoy = new Date().toISOString().split("T")[0];
      for (let i = 1; i <= 5; i++) {
        const f = document.getElementById(`fecha-${i}`);
        if (f) f.value = hoy;
      }
    }

    // DNI solo n√∫meros
    document.addEventListener("input", (e) => {
      if (e.target.id && e.target.id.startsWith("dni-")) {
        e.target.value = e.target.value.replace(/\D/g, "").substring(0, 9);
      }
    });

    function val(id) { return document.getElementById(id)?.value.trim() || ""; }

    // Enviar ‚Üí oculta formulario y t√≠tulo; muestra resultado
    document.getElementById("asistenciaForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const registros = [];
      listaNombresEl.innerHTML = "";

      for (let i = 1; i <= 5; i++) {
        const nombre = val(`nombre-${i}`);
        const apellido = val(`apellido-${i}`);
        const dni = val(`dni-${i}`);
        const comentarios = val(`comentarios-${i}`);
        const email = val(`email-${i}`); // se mantiene para el env√≠o (oculto)
        const fecha = val(`fecha-${i}`);

        // Ignorar registros totalmente vac√≠os
        if (!nombre && !apellido && !dni && !comentarios) continue;

        // Validaci√≥n m√≠nima (nombre, apellido, dni)
        if (!/^\d{7,9}$/.test(dni) || !nombre || !apellido) {
          alert("Revis√° Nombre, Apellido y DNI (7 a 9 d√≠gitos).");
          return;
        }

        registros.push({ nombre, apellido, dni, email, comentarios, fecha });

        // Agregar al listado visible
        const li = document.createElement("li");
        li.textContent = `${nombre} ${apellido}`;
        listaNombresEl.appendChild(li);
      }

      if (registros.length === 0) {
        alert("Carg√° al menos un Invitado.");
        return;
      }

      try {
        await fetch(WEBAPP_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ registros })
        });

        // Ocultar formulario y t√≠tulo
        document.getElementById("asistenciaForm").reset();
        formContainer.classList.add("d-none");
        tituloPrincipal.classList.add("d-none");

        // Mostrar resultado final
        resultado.classList.remove("d-none");

      } catch (err) {
        console.error(err);
        alert("Ocurri√≥ un error de red. Intent√° nuevamente.");
      }
    });
  </script>

</body>
</html>
